# Strapi 前端集成培训文档

## 4.1 数据获取配置

### 如何获取列表数据

#### 可传递参数配置

##### 分页参数 (page, pageSize)
```javascript
// 基础分页
GET /api/articles?pagination[page]=1&pagination[pageSize]=10

// 分页响应格式
{
  "data": [...],
  "meta": {
    "pagination": {
      "page": 1,
      "pageSize": 10,
      "pageCount": 5,
      "total": 50
    }
  }
}
```

##### 语言参数 (locale)
```javascript
// 多语言内容获取
GET /api/articles?locale=zh&locale=en

// 响应包含语言信息
{
  "data": [{
    "id": 1,
    "attributes": {
      "title": "文章标题",
      "locale": "zh"
    }
  }]
}
```

##### 排序参数 (sort)
```javascript
// 单字段排序
GET /api/articles?sort=createdAt:desc

// 多字段排序
GET /api/articles?sort[0]=publishedAt:desc&sort[1]=title:asc

// 数字字段排序
GET /api/articles?sort=order:asc
```

##### 过滤参数 (filters)
```javascript
// 精确匹配
GET /api/articles?filters[title][$eq]=特定标题

// 模糊搜索
GET /api/articles?filters[title][$containsi]=关键词

// 范围查询
GET /api/articles?filters[createdAt][$gte]=2024-01-01&filters[createdAt][$lte]=2024-12-31

// 关联字段过滤
GET /api/articles?filters[author][name][$eq]=作者姓名

// 多条件组合
GET /api/articles?filters[$and][0][publishedAt][$notNull]=true&filters[$and][1][category][name][$eq]=技术
```

#### 列表数据格式

##### 数据字段选择
```javascript
// 选择特定字段
GET /api/articles?fields[0]=title&fields[1]=description&fields[2]=slug

// 排除特定字段
GET /api/articles?fields[0]=title&fields[1]=description
```

##### 关联数据获取
```javascript
// 基础关联
GET /api/articles?populate=author,category

// 深层关联
GET /api/articles?populate[author][populate]=avatar&populate[category][populate]=*

// 关联字段选择
GET /api/articles?populate[author][fields][0]=name&populate[author][fields][1]=email

// 动态区内容
GET /api/articles?populate[blocks]=*

// 媒体文件
GET /api/articles?populate[cover]=*
```

##### 元数据信息
```javascript
// 获取元数据
{
  "data": [...],
  "meta": {
    "pagination": {...},
    "date": "2024-01-01T00:00:00.000Z"
  }
}
```

### 如何获取单页面数据配置

#### 单页面数据获取
```javascript
// 全局设置
GET /api/global?populate=*

// 关于页面
GET /api/about?populate[blocks]=*

// 单页面响应格式
{
  "data": {
    "id": 1,
    "attributes": {
      "siteName": "网站名称",
      "siteDescription": "网站描述",
      "favicon": {...},
      "defaultSeo": {...}
    }
  }
}
```

#### 页面配置参数
```javascript
// 带缓存的单页面请求
GET /api/global?populate=*&_cache=true

// 特定字段的单页面
GET /api/global?fields[0]=siteName&fields[1]=siteDescription
```

#### 动态内容加载
```javascript
// 动态区内容
GET /api/about?populate[blocks][populate]=*

// 响应格式
{
  "data": {
    "attributes": {
      "blocks": [
        {
          "__component": "shared.rich-text",
          "body": "<p>富文本内容</p>"
        },
        {
          "__component": "shared.media",
          "file": {...}
        }
      ]
    }
  }
}
```

#### 缓存配置
```javascript
// 前端缓存策略
const cacheConfig = {
  // 静态内容缓存 1 小时
  global: { ttl: 3600000 },
  // 动态内容缓存 5 分钟
  articles: { ttl: 300000 }
};

// 使用示例
const getGlobalData = async () => {
  const cached = localStorage.getItem('global_data');
  if (cached && Date.now() - JSON.parse(cached).timestamp < cacheConfig.global.ttl) {
    return JSON.parse(cached).data;
  }
  
  const response = await fetch('/api/global?populate=*');
  const data = await response.json();
  
  localStorage.setItem('global_data', JSON.stringify({
    data,
    timestamp: Date.now()
  }));
  
  return data;
};
```

### 如何获取绑定的组件配置

#### 组件数据获取
```javascript
// 获取所有共享组件
GET /api/components/shared/media
GET /api/components/shared/rich-text
GET /api/components/shared/quote
GET /api/components/shared/slider
GET /api/components/shared/seo
```

#### 组件关系配置
```javascript
// 文章中的动态区组件
GET /api/articles?populate[blocks][populate]=*

// 组件响应格式
{
  "data": [{
    "attributes": {
      "blocks": [
        {
          "__component": "shared.media",
          "file": {
            "data": {
              "attributes": {
                "url": "/uploads/image.jpg",
                "alternativeText": "图片描述"
              }
            }
          }
        },
        {
          "__component": "shared.quote",
          "title": "引用标题",
          "body": "引用内容"
        }
      ]
    }
  }]
}
```

#### 组件内容渲染
```javascript
// 前端组件渲染逻辑
const renderBlock = (block) => {
  switch (block.__component) {
    case 'shared.rich-text':
      return <div dangerouslySetInnerHTML={{ __html: block.body }} />;
    
    case 'shared.media':
      return <img src={block.file.data.attributes.url} alt={block.file.data.attributes.alternativeText} />;
    
    case 'shared.quote':
      return (
        <blockquote>
          <h3>{block.title}</h3>
          <p>{block.body}</p>
        </blockquote>
      );
    
    case 'shared.slider':
      return (
        <div className="slider">
          {block.files.data.map(file => (
            <img key={file.id} src={file.attributes.url} alt={file.attributes.alternativeText} />
          ))}
        </div>
      );
    
    default:
      return null;
  }
};
```

#### 组件样式配置
```javascript
// 组件样式配置
const componentStyles = {
  'shared.rich-text': {
    className: 'rich-text-content',
    styles: {
      lineHeight: '1.6',
      fontSize: '16px'
    }
  },
  'shared.quote': {
    className: 'quote-block',
    styles: {
      borderLeft: '4px solid #007bff',
      paddingLeft: '20px',
      fontStyle: 'italic'
    }
  }
};
```

### 如何获取详情页内容

#### 详情页数据获取
```javascript
// 文章详情
GET /api/articles/1?populate=*

// 通过 slug 获取
GET /api/articles?filters[slug][$eq]=article-slug&populate=*

// 详情页响应格式
{
  "data": [{
    "id": 1,
    "attributes": {
      "title": "文章标题",
      "description": "文章描述",
      "slug": "article-slug",
      "cover": {...},
      "author": {...},
      "category": {...},
      "blocks": [...],
      "publishedAt": "2024-01-01T00:00:00.000Z"
    }
  }]
}
```

#### 关联内容获取
```javascript
// 获取相关文章
GET /api/articles?filters[category][id][$eq]=1&filters[id][$ne]=1&populate=cover,author&sort=publishedAt:desc&pagination[limit]=3

// 获取作者的其他文章
GET /api/articles?filters[author][id][$eq]=1&filters[id][$ne]=1&populate=cover,category&sort=publishedAt:desc&pagination[limit]=5
```

#### 媒体文件获取
```javascript
// 获取文章封面
GET /api/articles/1?populate[cover]=*

// 获取动态区中的媒体
GET /api/articles/1?populate[blocks][populate]=*

// 媒体文件响应格式
{
  "data": {
    "attributes": {
      "cover": {
        "data": {
          "attributes": {
            "url": "/uploads/cover.jpg",
            "alternativeText": "封面图片",
            "width": 1200,
            "height": 630,
            "formats": {
              "thumbnail": {...},
              "small": {...},
              "medium": {...},
              "large": {...}
            }
          }
        }
      }
    }
  }
}
```

#### SEO 元数据获取
```javascript
// 获取文章 SEO 数据
GET /api/articles/1?populate[seo]=*

// 获取全局 SEO 设置
GET /api/global?populate[defaultSeo]=*

// SEO 数据使用
const getSEOMeta = (article, global) => {
  const seo = article.attributes.seo || global.attributes.defaultSeo;
  
  return {
    title: seo.metaTitle || article.attributes.title,
    description: seo.metaDescription || article.attributes.description,
    image: seo.shareImage?.data?.attributes?.url || article.attributes.cover?.data?.attributes?.url,
    url: `${process.env.NEXT_PUBLIC_SITE_URL}/articles/${article.attributes.slug}`
  };
};
```

## 前端集成最佳实践

### 1. 错误处理
```javascript
const fetchData = async (url) => {
  try {
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('API请求失败:', error);
    throw error;
  }
};
```

### 2. 加载状态管理
```javascript
const useStrapiData = (url) => {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        const result = await fetchData(url);
        setData(result);
      } catch (err) {
        setError(err);
      } finally {
        setLoading(false);
      }
    };
    
    fetchData();
  }, [url]);
  
  return { data, loading, error };
};
```

### 3. 类型安全 (TypeScript)
```typescript
interface StrapiResponse<T> {
  data: T;
  meta: {
    pagination?: {
      page: number;
      pageSize: number;
      pageCount: number;
      total: number;
    };
  };
}

interface Article {
  id: number;
  attributes: {
    title: string;
    description: string;
    slug: string;
    cover?: MediaFile;
    author?: Author;
    category?: Category;
    blocks?: DynamicBlock[];
    publishedAt: string;
  };
}
```

### 4. 性能优化
```javascript
// 预加载关键数据
const preloadCriticalData = async () => {
  const [global, categories] = await Promise.all([
    fetch('/api/global?populate=*'),
    fetch('/api/categories?populate=*')
  ]);
  
  return {
    global: await global.json(),
    categories: await categories.json()
  };
};

// 图片懒加载
const LazyImage = ({ src, alt, ...props }) => {
  const [loaded, setLoaded] = useState(false);
  
  return (
    <img
      {...props}
      src={loaded ? src : '/placeholder.jpg'}
      alt={alt}
      onLoad={() => setLoaded(true)}
    />
  );
};
```

---

*此文档基于 Strapi v5.28.0 和当前项目结构编写*
